<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Despachos | VPS UFCAT</title>
    <style>
        :root { --p: #2c3e50; --s: #34495e; --acc: #27ae60; --inf: #2980b9; --err: #c0392b; --bg: #f1f2f6; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: flex-start; padding: 20px; gap: 20px; flex-wrap: wrap; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 480px; }
        .card-lg { width: 100%; max-width: 1100px; }
        h2 { text-align: center; color: var(--p); font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        textarea { width: 100%; height: 110px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; box-sizing: border-box; font-size: 13px; }
        .grid { display: grid; grid-template-columns: 85px 1fr 45px; gap: 8px; align-items: center; margin-top: 10px; }
        .grid label { font-size: 12px; font-weight: bold; color: var(--s); text-align: right; }
        .grid input, .grid select { width: 100%; padding: 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .btn { border: none; border-radius: 4px; cursor: pointer; padding: 8px; transition: 0.2s; background: var(--s); color: white; }
        .btn:hover { opacity: 0.9; }
        .btn-main { background: var(--acc); width: 100%; font-weight: bold; padding: 12px; margin: 10px 0; font-size: 14px; }
        .btn-save { background: var(--inf); width: 100%; font-weight: bold; margin-top: 10px; }
        .btn-clear { background: #95a5a6; width: 100%; margin-top: 5px; font-size: 11px; }
        .opt { grid-column: 1 / span 3; display: flex; justify-content: space-around; background: #f9f9f9; padding: 8px; border-radius: 5px; font-size: 11px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        th { background: var(--p); color: white; padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .actions { display: flex; gap: 5px; margin-bottom: 10px; }
        #siorg { background-color: #e9ecef; font-weight: bold; color: #495057; }
    </style>
</head>
<body>

    <div class="card">
        <h2>1. Dados do Comprasnet</h2>
        <textarea id="in" placeholder="Cole os dados aqui..."></textarea>
        <button onclick="extrair()" class="btn btn-main">‚ö° EXTRAIR DADOS</button>
        
        <div class="grid">
            <label>Tipo Doc.</label>
            <select id="tipo_doc"><option>NF</option><option>DOC</option><option>Fatura</option></select>
            <div></div>
            <label>Processo</label><input type="text" id="processo"> <button class="btn" onclick="copy('processo')">üìã</button>
            <label>CNPJ</label><input type="text" id="cnpj"> <button class="btn" onclick="copy('cnpj')">üìã</button>
            <label>N¬∫ Doc</label><input type="text" id="nf"> <button class="btn" onclick="copy('nf')">üìã</button>
            <label>Valor R$</label><input type="text" id="valor"> <button class="btn" onclick="copy('valor')">üìã</button>
            <label>Emiss√£o</label><input type="text" id="data_emissao"> <button class="btn" onclick="copy('data_emissao')">üìã</button>
            <label>REF.</label><input type="text" id="ref"> <button class="btn" onclick="copy('ref')">üìã</button>
            <label>Ref. Serv.</label><input type="text" id="ref_servico"> <button class="btn" onclick="copy('ref_servico')">üìã</button>
            <label>Contrato</label><input type="text" id="contrato"> <button class="btn" onclick="copy('contrato')">üìã</button>
            
            <label title="UGR Centro de Custo (SIPAC)">C. Custo</label>
            <input type="text" id="centro_custo" placeholder="Ex: 157128" onkeyup="buscarSiorg()"> 
            <button class="btn" onclick="copy('centro_custo')">üìã</button>

            <label title="SIORG (SIAFI)">SIORG</label>
            <input type="text" id="siorg" readonly placeholder="C√≥digo SIORG"> 
            <button class="btn" onclick="copy('siorg')">üìã</button>

            <label>Fonte</label><input type="text" id="fonte"> <button class="btn" onclick="copy('fonte')">üìã</button>
            
            <label>Simples?</label>
            <select id="simples"><option value="N√£o">N√£o</option><option value="Sim">Sim</option></select>
            <div></div>
            <div class="opt">
                <label><input type="checkbox" id="check_ref" checked> Ref. Serv.</label>
                <label><input type="checkbox" id="check_con" checked> Contrato</label>
            </div>
        </div>
        <button onclick="limpar()" class="btn btn-clear">Limpar Campos</button>
    </div>

    <div class="card">
        <h2>2. Despacho</h2>
        <div class="actions">
            <button class="btn" style="flex:1" onclick="gerar('LIQUIDA√á√ÉO')">Liquida√ß√£o</button>
            <button class="btn" style="flex:1" onclick="gerar('PAGAMENTO')">Pagamento</button>
            <button class="btn" style="flex:1" onclick="gerar('TRIB. FED.')">TRIB</button>
            <button class="btn" style="flex:1" onclick="gerar('ISS')">ISS</button>
        </div>
        <textarea id="out" style="height: 150px; font-weight: bold; border-color: var(--inf); color: var(--p);"></textarea>
        <button onclick="salvar()" class="btn btn-save">üíæ SALVAR NO HIST√ìRICO</button>
    </div>

    <div class="card card-lg">
        <h2>3. Hist√≥rico de Atividades</h2>
        <div class="actions">
            <button class="btn" style="background:var(--acc)" onclick="exportar()">üì• Exportar Excel (CSV)</button>
            <button class="btn" style="background:var(--err); margin-left: auto;" onclick="limparDB()">üóëÔ∏è Apagar Tudo</button>
        </div>
        <div style="overflow-x:auto">
            <table id="tb">
                <thead><tr><th>Data</th><th>Processo</th><th>Doc</th><th>Valor</th><th>Despacho</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
    // Banco de dados SIORG - UFCAT (Mapeamento duplo: UGR e Centro de Custo)
    const mapeamentoSiorg = {
        // Auditoria, Museus, Biblioteca, etc.
        "157158": "282868", "11020030": "282868",
        "157159": "284833", "11020034": "284833",
        "157148": "244268", "110209": "244268",
        "157127": "218145", "110231": "218145",
        "157151": "282854", "1102001602": "282854",
        "157152": "282856", "1102001601": "282856",
        "157396": "304420", "110200210701": "304420",
        "157397": "304125", "1102001810": "304125",
        "157398": "387089", "1102003502": "387089",
        "157399": "387129", "1102160102": "387129",
        "157400": "284912", "11022902": "284912",
        "157153": "282855", "1102001603": "282855",
        "157154": "284832", "11020033": "284832",
        "157155": "244894", "11020017": "244894",
        
        // Faculdades e Institutos
        "157129": "207865", "110207": "207865", // <--- Faculdade de Educa√ß√£o (O que voc√™ buscou)
        "157130": "207870", "110201": "207870",
        "157128": "244270", "11020016": "244270",
        "157131": "207868", "110202": "207868",
        "157132": "207864", "110206": "207864",
        "157133": "207867", "11020002": "207867",
        "157134": "207866", "110208": "207866",
        "157135": "207869", "110203": "207869",
        "157136": "207863", "110205": "207863",
        "157137": "282920", "1102002105": "282920",
        "157156": "282866", "11020032": "282866",
        
        // P√≥s-Gradua√ß√µes (PPG)
        "157401": "284937", "1102000204": "284937",
        "157402": "282908", "1102000207": "282908",
        "157403": "293029", "11020706": "293029",
        "157404": "282914", "11020107": "282914",
        "157406": "282915", "11020106": "282915",
        "157407": "293047", "11020604": "293047",
        "157408": "293037", "11020804": "293037",
        "157409": "282919", "11020502": "282919",
        "157353": "293054", "110200210506": "293054",
        "157410": "284944", "110200210503": "284944",
        "157411": "293039", "11023104": "293039",
        "157412": "293044", "11020306": "293044",
        "157413": "284942", "11020504": "284942",
        "157414": "284866", "11020904": "284866",

        // Pr√≥-Reitorias e Secretarias
        "157138": "304381", "11020035": "304381",
        "157139": "218253", "110216": "218253",
        "157140": "244313", "110218": "244313",
        "157141": "218314", "110215": "218314",
        "157142": "218182", "110220": "218182",
        "157231": "218160", "110221": "218160",
        "157143": "218141", "110227": "218141",
        "157157": "282867", "11020031": "282867",
        "157144": "282858", "11020029": "282858",
        "157146": "244895", "11020018": "244895",
        "157147": "218137", "110213": "218137"
    };

    function buscarSiorg() {
        const cc = document.getElementById('centro_custo').value.trim();
        const siorgInput = document.getElementById('siorg');
        // A busca agora funciona tanto para o c√≥digo da 3¬™ coluna quanto da 4¬™ coluna da sua tabela
        siorgInput.value = mapeamentoSiorg[cc] || "";
    }

    window.onload = listar;
    function extrair() {
        const t = document.getElementById('in').value;
        const r = {
            contrato: /Contrato\s+([\d\/]+)/, nf: /N√∫mero do\s+Documento\s+([\d\.]+)/,
            data_emissao: /Dt\.\s+Emiss√£o\s+([\d\/]+)/, valor: /Valor\s+R\$\s*([\d\.,]+)/,
            processo: /Processo\s+([\d\.\/\-]+)/, cnpj: /Fornecedor\s+([\d\.\/\-]+)/,
            ref: /Refer√™ncia\s+Ano M√™s Valor\s+(\d{4})\s+(\d{2})/
        };
        for(let k in r) {
            let m = t.match(r[k]);
            if(m) {
                if(k === 'ref') document.getElementById('ref').value = `${m[2]}/${m[1]}`;
                else document.getElementById(k).value = m[1].trim();
            }
        }
    }

    function gerar(acao) {
        const v = (id) => document.getElementById(id).value;
        let d = `${acao} DA ${v('tipo_doc')} ${v('nf')} DE ${v('data_emissao')} - VALOR R$ ${v('valor')} - REF. ${v('ref')}`;
        if(document.getElementById('check_ref').checked && v('ref_servico')) d += ` - REF. SERVI√áO ${v('ref_servico')}`;
        if(document.getElementById('check_con').checked && v('contrato')) d += ` - CONTRATO ${v('contrato')}`;
        
        // Se houver SIORG, pode-se incluir no texto se desejar, sen√£o mant√©m o padr√£o:
        d += ` - PROCESSO: ${v('processo')} - FONTE: ${v('fonte')}`;
        
        if(v('simples') === 'Sim') d += ' - OPTANTE DO SIMPLES NACIONAL';
        document.getElementById('out').value = d.toUpperCase();
    }

    async function copy(id) {
        const input = document.getElementById(id);
        if(input.value) {
            await navigator.clipboard.writeText(input.value);
            input.style.backgroundColor = "#d4edda";
            setTimeout(() => input.style.backgroundColor = id === 'siorg' ? '#e9ecef' : '', 500);
        }
    }

    function salvar() {
        const d = document.getElementById('out').value;
        if(!d) return;
        const reg = { 
            ts: new Date().toLocaleString('pt-BR'), 
            pr: document.getElementById('processo').value,
            doc: document.getElementById('nf').value,
            val: document.getElementById('valor').value,
            txt: d 
        };
        let db = JSON.parse(localStorage.getItem('db_desp') || '[]');
        db.unshift(reg);
        localStorage.setItem('db_desp', JSON.stringify(db));
        listar();
    }

    function listar() {
        const db = JSON.parse(localStorage.getItem('db_desp') || '[]');
        const b = document.querySelector('#tb tbody');
        b.innerHTML = db.map(i => `<tr><td>${i.ts}</td><td>${i.pr}</td><td>${i.doc}</td><td>${i.val}</td><td title="${i.txt}">${i.txt.substring(0,60)}...</td></tr>`).join('');
    }

    function exportar() {
        const db = JSON.parse(localStorage.getItem('db_desp') || '[]');
        let c = "\uFEFFData;Processo;Documento;Valor;Despacho\n";
        db.forEach(i => c += `${i.ts};${i.pr};${i.doc};${i.val};"${i.txt}"\n`);
        const l = document.createElement("a");
        l.href = URL.createObjectURL(new Blob([c], {type:'text/csv'}));
        l.download = "despachos.csv";
        l.click();
    }

    function limpar() {
        ['in','processo','cnpj','nf','valor','data_emissao','ref','ref_servico','contrato','fonte','out','centro_custo','siorg'].forEach(id => document.getElementById(id).value = '');
    }

    function limparDB() { if(confirm("Apagar hist√≥rico?")) { localStorage.removeItem('db_desp'); listar(); } }
</script>
</body>
</html>